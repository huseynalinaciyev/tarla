<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sadə Tarla Oyunu (HTML5)</title>
  <style>
    :root{--bg:#f0f7ef;--card:#fff;--accent:#4caf50;--muted:#666}
    body{font-family:Inter,Segoe UI,Helvetica,Arial;background:var(--bg);margin:0;padding:20px}
    h1{margin:0 0 10px;font-size:20px}
    .top{display:flex;gap:12px;align-items:center}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    .stats{display:flex;gap:12px;align-items:center}
    .stat{padding:8px 12px;border-radius:10px;background:#f7fff6;border:1px solid #e6f5ea}
    button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .controls{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .farm{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .slot{background:#fff;border-radius:10px;padding:10px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between}
    .slot .title{font-weight:600}
    .slot .meta{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .small{padding:6px 8px;font-size:13px}
    .green{background:#2e7d32}
    .danger{background:#b71c1c}
    .buy{background:#1565c0}
    footer{margin-top:18px;font-size:13px;color:var(--muted)}
    .log{max-height:140px;overflow:auto;padding:8px;background:#fff;border-radius:8px;margin-top:10px}
    label{font-size:13px}
    .badge{background:#e8f5e9;color:#2e7d32;padding:4px 8px;border-radius:999px;font-weight:600}
  </style>
</head>
<body>
  <h1>Sadə Tarla Oyunu</h1>
  <div class="top">
    <div class="panel stats">
      <div class="stat">Coins: <span id="coins">0</span></div>
      <div class="stat">Slots: <span id="slotsCount">4</span></div>
      <div class="stat">Plants in stock: <span id="plantsStock">0</span></div>
      <div class="stat">Chickens: <span id="chickensCount">0</span></div>
    </div>
    <div style="margin-left:auto" class="panel">
      <label>Test modu (1 oyun saat = 60s)</label>
      <div class="controls" style="margin-top:6px">
        <button id="toggleTime" class="small">Toggle Test/Real</button>
        <button id="reset" class="small danger">Reset Save</button>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:12px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <strong>Əməliyyatlar</strong>
        <div class="controls" style="margin-top:8px">
          <button id="plantBtn" class="small">Əkin (seeds pulsuz)</button>
          <button id="waterAll" class="small">Hamısını suvar</button>
          <button id="harvestAll" class="small">Hamısını yığ</button>
          <button id="sellAll" class="small">Hamısını sat (1 coin/bitki)</button>
          <button id="sellEggs" class="small">Yumurtaları sat (5 coin/əd)</button>
        </div>
      </div>
      <div>
        <strong>Mağaza</strong>
        <div class="controls" style="margin-top:8px">
          <button id="buySlot" class="small buy">Yeni slot al (100 coin)</button>
          <button id="buyChicken" class="small buy">Toyuq al (100000 coin)</button>
        </div>
      </div>
    </div>

    <div class="log" id="logArea"></div>
  </div>

  <div class="farm" id="farm"></div>

  <footer>
    Qaydalar: Bitki əkildikdən sonra <span class="badge">1 oyun saat</span> gözləyib suvarılmalıdır. Suvarıldıqdan sonra <span class="badge">2 oyun saat</span> sonra məhsul yığılmağa hazır olur. Satış — hər bitki üçün 1 coin. Toyuq 100000 coin-ə alındıqdan sonra hər <span class="badge">1 oyun saatda</span> 1 yumurta qoyur. Yumurtanı satanda 5 coin qazandırır. Test modunda 1 oyun saat = 60 saniyə (oyun test üçün sürətlə idarə oluna bilər).
  </footer>

  <script>
    // Sadə HTML5 ferma oyunu
    // Saxlama açarları
    const SAVE_KEY = 'farm_save_v1';

    // Game settings (gameHourMs: how many real ms equals 1 in-game hour)
    const REAL_GAME_HOUR = 60*60*1000; // 1 real hour
    const TEST_GAME_HOUR = 60*1000; // 1 minute for testing

    let gameHourMs = TEST_GAME_HOUR; // default to test mode for development
    let timeMode = 'test'; // 'test' or 'real'

    // Game state
    const state = {
      coins: 0,
      slots: [], // each slot: null or plant object
      slotsCount: 4,
      chickens: 0,
      eggs: 0,
      lastTick: Date.now(),
    };

    // Plant rules: after planting -> wait 1 hour to water; after watering -> wait 2 hours to harvest
    const WATER_WAIT_HOURS = 1;
    const HARVEST_AFTER_WATER_HOURS = 2;

    // Init
    function load() {
      const raw = localStorage.getItem(SAVE_KEY);
      if (raw) {
        try { Object.assign(state, JSON.parse(raw)); }
        catch(e){ console.warn('save load failed',e); }
      }
      // ensure slots exist
      if (!state.slots || !Array.isArray(state.slots)) state.slots = [];
      while (state.slots.length < state.slotsCount) state.slots.push(null);
      render();
    }

    function save() {
      state.lastTick = Date.now();
      localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }

    // Helpers
    function log(msg){
      const el = document.getElementById('logArea');
      const p = document.createElement('div');
      p.textContent = '['+new Date().toLocaleTimeString()+'] '+msg;
      el.prepend(p);
      if (el.childNodes.length>200) el.removeChild(el.lastChild);
    }

    function render(){
      document.getElementById('coins').textContent = state.coins;
      document.getElementById('slotsCount').textContent = state.slotsCount;
      document.getElementById('plantsStock').textContent = state.slots.filter(s=>s).length;
      document.getElementById('chickensCount').textContent = state.chickens;

      const farm = document.getElementById('farm');
      farm.innerHTML = '';
      state.slots.forEach((slot, idx)=>{
        const div = document.createElement('div');
        div.className = 'slot panel';
        if (!slot) {
          div.innerHTML = `<div><div class="title">Boş Slot #${idx+1}</div><div class="meta">Buraya əkilə bilər</div></div>
            <div class="actions"><button class="small" onclick="plantAt(${idx})">Əkin</button></div>`;
        } else {
          const plantedAt = new Date(slot.plantedAt);
          const wateredAt = slot.wateredAt ? new Date(slot.wateredAt) : null;
          const now = Date.now();
          let statusText = '';
          let canWater = false;
          let canHarvest = false;
          if (!slot.watered) {
            const msToWater = slot.plantedAt + WATER_WAIT_HOURS*gameHourMs - now;
            if (msToWater <= 0) { statusText = 'Suvarmağa hazır'; canWater = true; }
            else statusText = 'Suvarmaq üçün: ' + fmtMs(msToWater);
          } else {
            const msToHarvest = slot.wateredAt + HARVEST_AFTER_WATER_HOURS*gameHourMs - now;
            if (msToHarvest <= 0) { statusText = 'Yığmağa hazır'; canHarvest = true; }
            else statusText = 'Yığım üçün: ' + fmtMs(msToHarvest);
          }

          div.innerHTML = `<div>
            <div class="title">Bitki #${idx+1}</div>
            <div class="meta">Əkilmə vaxtı: ${plantedAt.toLocaleTimeString()}</div>
            <div class="meta">${wateredAt ? 'Son suvarma: '+wateredAt.toLocaleTimeString() : 'Hələ suvarılmayıb'}</div>
            <div class="meta" style="margin-top:6px"><strong>${statusText}</strong></div>
          </div>
          <div class="actions">
            <button class="small" onclick="removePlant(${idx})">Sil</button>
            <button class="small green" ${canWater? '':'disabled'} onclick="waterAt(${idx})">Suvar</button>
            <button class="small buy" ${canHarvest? '':'disabled'} onclick="harvestAt(${idx})">Yığ</button>
            <button class="small" onclick="sellPlant(${idx})">Sat (1 coin)</button>
          </div>`;
        }
        farm.appendChild(div);
      });

      // Show chickens and eggs area below farm
      const chickensDiv = document.createElement('div');
      chickensDiv.className = 'panel';
      chickensDiv.style.gridColumn = '1/-1';
      chickensDiv.style.marginTop = '6px';
      chickensDiv.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Toyuqlar: </strong>${state.chickens} &nbsp; <strong>Yumurtalar: </strong>${state.eggs}</div>
        <div class="actions"><button class="small" onclick="collectEggs()">Yumurtaları toplama (pul üçün)</button></div>
      </div>`;
      farm.appendChild(chickensDiv);

      save();
    }

    function fmtMs(ms){
      if (ms<=0) return '0s';
      const s = Math.ceil(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      if (h>0) return `${h}h ${m}m`;
      if (m>0) return `${m}m ${sec}s`;
      return `${sec}s`;
    }

    // Actions
    window.plantAt = function(idx){
      if (state.slots[idx]) { alert('Bu slot doludur'); return; }
      const plant = { plantedAt: Date.now(), watered: false, wateredAt: null };
      state.slots[idx] = plant;
      log('Slot #'+(idx+1)+' əkildi');
      render();
    }

    window.removePlant = function(idx){
      if (!state.slots[idx]) return; state.slots[idx] = null; log('Slot #'+(idx+1)+' silindi'); render();
    }

    window.waterAt = function(idx){
      const slot = state.slots[idx]; if (!slot) return;
      const now = Date.now();
      if (slot.watered) { alert('Artıq suvarılıb'); return; }
      const readyTime = slot.plantedAt + WATER_WAIT_HOURS*gameHourMs;
      if (now < readyTime) { alert('Hələ suvarılmağa hazır deyil'); return; }
      slot.watered = true; slot.wateredAt = now; log('Slot #'+(idx+1)+' suvarıldı'); render();
    }

    window.harvestAt = function(idx){
      const slot = state.slots[idx]; if (!slot) return;
      if (!slot.watered) { alert('Əvvəlcə suvarılmalıdır'); return; }
      const ready = slot.wateredAt + HARVEST_AFTER_WATER_HOURS*gameHourMs;
      if (Date.now() < ready) { alert('Hələ yığmaq olmaz'); return; }
      // harvest yields 1 plant item that can be sold immediately
      state.coins += 0; // harvesting itself doesn't give coins until sell or auto-sell
      // We'll mark slot as harvested by deleting plant and increasing stock count -> but user wanted selling immediately removes from stock
      // To keep simple: harvesting converts plant to 'harvested' and then selling removes it. But user wanted selling remove from stock. We'll implement harvest -> slot becomes empty and coin not added; user must press sell to get coin? But user wanted selling gives 1 coin and removes from stock. Ok we'll auto-add to inventory via incrementing a 'harvestedCount'? Simpler: When harvest, we increment 'harvestedCount' and free slot.
      state.slots[idx] = null;
      state.harvested = (state.harvested||0)+1;
      log('Slot #'+(idx+1)+' məhsul yığıldı (1 ədəd) — satmaq üçün "Hamısını sat" düyməsindən istifadə et');
      render();
    }

    window.sellPlant = function(idx){
      const slot = state.slots[idx];
      if (!slot) { alert('Bu slotda bitki yoxdur'); return; }
      // Allow direct selling even if not harvested: user asked "satdiqda stokumdan bitgi silinsin ve coin balansima elave edilsin" so selling should remove plant and give 1 coin
      state.slots[idx] = null;
      state.coins += 1;
      log('Slot #'+(idx+1)+' satıldı — +1 coin');
      render();
    }

    document.getElementById('plantBtn').addEventListener('click', ()=>{
      // find first empty slot
      const idx = state.slots.findIndex(s=>!s);
      if (idx === -1) { alert('Bütün slotlar doludur. Yeni slot almaq üçün mağazaya bax.'); return; }
      plantAt(idx);
    });

    document.getElementById('waterAll').addEventListener('click', ()=>{
      let count = 0;
      state.slots.forEach((s,idx)=>{
        if (s && !s.watered && Date.now() >= s.plantedAt + WATER_WAIT_HOURS*gameHourMs) { s.watered = true; s.wateredAt = Date.now(); count++; }
      });
      log('Hamısı suvarıldı: '+count+' ədəd'); render();
    });

    document.getElementById('harvestAll').addEventListener('click', ()=>{
      let count = 0;
      state.slots.forEach((s,idx)=>{
        if (s && s.watered && Date.now() >= s.wateredAt + HARVEST_AFTER_WATER_HOURS*gameHourMs) { state.slots[idx] = null; state.harvested = (state.harvested||0)+1; count++; }
      });
      log('Hamısı yığıldı: '+count+' ədəd (satmaq üçün "Hamısını sat" düyməsi)'); render();
    });

    document.getElementById('sellAll').addEventListener('click', ()=>{
      const harvested = state.harvested || 0;
      if (harvested>0){ state.coins += harvested*1; log('Satış edildi: '+harvested+' məhsul — +'+(harvested*1)+' coin'); state.harvested=0; }
      // also sell any direct plants? We'll only sell harvested here
      render();
    });

    document.getElementById('sellEggs').addEventListener('click', ()=>{
      if (state.eggs>0){ state.coins += state.eggs*5; log('Yumurtalar satıldı: '+state.eggs+' — +'+(state.eggs*5)+' coin'); state.eggs=0; render(); }
      else alert('Yumurta yoxdur');
    });

    document.getElementById('buySlot').addEventListener('click', ()=>{
      const cost = 100;
      if (state.coins < cost){ alert('Kifayət qədər coin yoxdur'); return; }
      state.coins -= cost; state.slotsCount += 1; state.slots.push(null); log('Yeni slot alındı (+1)'); render();
    });

    document.getElementById('buyChicken').addEventListener('click', ()=>{
      const cost = 100000;
      if (state.coins < cost){ alert('Kifayət qədər coin yoxdur (100000 tələb olunur)'); return; }
      state.coins -= cost; state.chickens += 1; log('Toyuq alındı!'); render();
    });

    function collectEggs(){
      if (state.eggs<=0) { alert('Yumurta yoxdur'); return; }
      const gained = state.eggs*5; state.coins += gained; log('Yumurtalar satıldı: '+state.eggs+' — +'+gained+' coin'); state.eggs=0; render();
    }

    document.getElementById('toggleTime').addEventListener('click', ()=>{
      if (timeMode === 'test'){ timeMode = 'real'; gameHourMs = REAL_GAME_HOUR; document.getElementById('toggleTime').textContent='Switch to Test'; log('Reallıq moduna keçdi (1 oyun saat = 1 real saat)'); }
      else { timeMode = 'test'; gameHourMs = TEST_GAME_HOUR; document.getElementById('toggleTime').textContent='Switch to Real'; log('Test moduna keçdi (1 oyun saat = 60s)'); }
      render();
    });

    document.getElementById('reset').addEventListener('click', ()=>{
      if (!confirm('Saxlanmış məlumat silinəcək. Davam edilsin?')) return;
      localStorage.removeItem(SAVE_KEY); location.reload();
    });

    // Tick: handle passive events, like chickens laying eggs every game hour
    function tick(){
      const now = Date.now();
      // compute how many full game hours passed since lastTick
      const last = state.lastTick || now;
      const dt = now - last;
      if (dt <=0) { state.lastTick = now; save(); return; }
      const hoursPassed = Math.floor(dt / gameHourMs);
      if (hoursPassed > 0) {
        // chickens lay eggs: each chicken lays 1 egg per game hour
        state.eggs = (state.eggs || 0) + state.chickens * hoursPassed;
        if (state.chickens>0) log(state.chickens+' toyuq '+hoursPassed+' oyun saatında '+(state.chickens*hoursPassed)+' yumurta qoydu');
        state.lastTick = last + hoursPassed*gameHourMs;
        save();
      }
      // update UI timers
      renderTimers();
    }

    function renderTimers(){
      // Just update render without saving too often
      const farm = document.getElementById('farm');
      if (!farm) return; // not loaded yet
      // We don't re-render whole DOM to avoid flicker; but for simplicity we'll re-render fully every second
      render();
    }

    // Utility: sell harvested items automatically when harvesting? We left selling manual. But user asked selling removes from stock and adds coins. We implemented direct sell button per slot and sellAll for harvested.

    // Start interval
    load();
    state.lastTick = state.lastTick || Date.now();
    setInterval(tick, 1000);

    // Expose for debug
    window._state = state;
  </script>
</body>
</html>
